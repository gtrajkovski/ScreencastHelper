{% extends "base.html" %}
{% block title %}Player - {{ project.name }}{% endblock %}

{% block nav_items %}
<a href="/dashboard" class="nav-link">Dashboard</a>
<a href="/workspace/{{ project.id }}" class="nav-link">Workspace</a>
<a href="/player/{{ project.id }}" class="nav-link active">Player</a>
{% endblock %}

{% block head %}
<style>
    .player-layout { display: flex; height: calc(100vh - 52px); overflow: hidden; }
    .player-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .player-content { flex: 1; overflow-y: auto; padding: 24px; background: var(--bg-primary); }
    .player-controls { padding: 12px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 16px; flex-shrink: 0; }
    .player-controls .time-display { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-muted); min-width: 100px; }
    .progress-bar { flex: 1; height: 6px; background: var(--bg-card); border-radius: 3px; cursor: pointer; position: relative; }
    .progress-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.2s; width: 0%; }

    .player-sidebar { width: 350px; background: var(--bg-secondary); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; }
    .sidebar-header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); font-weight: 600; font-size: 15px; flex-shrink: 0; }
    .segment-timeline { flex: 1; overflow-y: auto; }

    .timeline-seg { padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.15s; }
    .timeline-seg:hover { background: var(--bg-card); }
    .timeline-seg.active { background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent); }
    .timeline-seg .tl-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .timeline-seg .tl-section { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--accent); }
    .timeline-seg .tl-time { font-size: 11px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
    .timeline-seg .tl-title { font-size: 13px; font-weight: 600; }
    .timeline-seg .tl-narration { font-size: 12px; color: var(--text-secondary); margin-top: 4px; max-height: 60px; overflow: hidden; }

    .current-segment-display { padding: 16px; }
    .current-narration { font-size: 16px; line-height: 1.7; margin-bottom: 16px; }
    .current-visual-cue { background: rgba(245, 158, 11, 0.1); color: var(--accent-warning); padding: 8px 12px; border-radius: 6px; font-size: 13px; margin-bottom: 12px; font-family: monospace; }
    .current-code { background: #1e1e1e; border-radius: 8px; padding: 16px; font-family: 'JetBrains Mono', monospace; font-size: 14px; line-height: 1.5; overflow-x: auto; white-space: pre; margin-bottom: 12px; }
</style>
{% endblock %}

{% block content %}
<div class="player-layout">
    <div class="player-main">
        <div class="player-content" id="player-content">
            <div class="current-segment-display" id="current-display">
                <div style="text-align: center; color: var(--text-muted); padding: 60px;">
                    Press Play to start the presentation
                </div>
            </div>
        </div>
        <div class="player-controls">
            <button class="btn btn-primary" id="btn-play" onclick="togglePlay()">&#9654; Play</button>
            <div class="time-display" id="time-display">0:00 / 0:00</div>
            <div class="progress-bar" id="progress-bar" onclick="seekTo(event)">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

    <div class="player-sidebar">
        <div class="sidebar-header">Segments</div>
        <div class="segment-timeline" id="segment-timeline">
            <div style="padding: 20px; color: var(--text-muted); text-align: center;">Loading timeline...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const PROJECT_ID = '{{ project.id }}';
let timeline = null;
let currentSegIdx = 0;
let isPlaying = false;
let audioElements = {};
let currentAudio = null;
let totalDuration = 0;
let elapsedTime = 0;
let playInterval = null;

async function loadTimeline() {
    try {
        const data = await api(`/api/projects/${PROJECT_ID}/timeline`);
        timeline = data;
        totalDuration = data.total_duration;
        renderTimeline(data.segments);
        if (data.segments.length > 0) showSegment(0);
    } catch (err) {
        showToast('Failed to load timeline: ' + err.message, 'error');
    }
}

function renderTimeline(segments) {
    const container = document.getElementById('segment-timeline');
    container.innerHTML = segments.map((s, i) => `
        <div class="timeline-seg${i === 0 ? ' active' : ''}" data-idx="${i}" onclick="jumpToSegment(${i})">
            <div class="tl-header">
                <span class="tl-section">${escapeHtml(s.section)}</span>
                <span class="tl-time">${formatTime(s.start_time)}</span>
            </div>
            <div class="tl-title">${escapeHtml(s.title)}</div>
            <div class="tl-narration">${escapeHtml((s.narration || '').substring(0, 120))}...</div>
        </div>
    `).join('');
}

function showSegment(idx) {
    if (!timeline || idx >= timeline.segments.length) return;
    currentSegIdx = idx;
    const seg = timeline.segments[idx];

    // Update timeline highlighting
    document.querySelectorAll('.timeline-seg').forEach(el => el.classList.remove('active'));
    const el = document.querySelector(`.timeline-seg[data-idx="${idx}"]`);
    if (el) { el.classList.add('active'); el.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }

    // Render segment content
    let html = '<div class="current-segment-display">';
    if (seg.visual_cue) html += `<div class="current-visual-cue">[SCREEN: ${escapeHtml(seg.visual_cue)}]</div>`;
    html += `<div class="current-narration">${escapeHtml(seg.narration || '').replace(/\n/g, '<br>')}</div>`;
    if (seg.code) html += `<div class="current-code">${escapeHtml(seg.code)}</div>`;
    html += '</div>';
    document.getElementById('current-display').innerHTML = html;
}

function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }

function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${m}:${s.toString().padStart(2, '0')}`;
}

function updateTimeDisplay() {
    document.getElementById('time-display').textContent = `${formatTime(elapsedTime)} / ${formatTime(totalDuration)}`;
    const pct = totalDuration > 0 ? (elapsedTime / totalDuration) * 100 : 0;
    document.getElementById('progress-fill').style.width = pct + '%';

    // Check if we need to advance to next segment
    if (timeline && timeline.segments.length > 0) {
        for (let i = timeline.segments.length - 1; i >= 0; i--) {
            if (elapsedTime >= timeline.segments[i].start_time) {
                if (i !== currentSegIdx) showSegment(i);
                break;
            }
        }
    }
}

function togglePlay() {
    const btn = document.getElementById('btn-play');
    if (isPlaying) {
        isPlaying = false;
        btn.innerHTML = '&#9654; Play';
        if (currentAudio) currentAudio.pause();
        clearInterval(playInterval);
    } else {
        isPlaying = true;
        btn.innerHTML = '&#9646;&#9646; Pause';
        playSegmentAudio(currentSegIdx);
        playInterval = setInterval(() => {
            elapsedTime += 0.5;
            updateTimeDisplay();
            if (elapsedTime >= totalDuration) {
                togglePlay(); elapsedTime = 0; showSegment(0); updateTimeDisplay();
            }
        }, 500);
    }
}

function playSegmentAudio(idx) {
    if (!timeline || idx >= timeline.segments.length) return;
    const seg = timeline.segments[idx];
    if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }

    const audioUrl = `/api/audio/${seg.id}?project_id=${PROJECT_ID}`;
    const audio = new Audio(audioUrl);
    audio.addEventListener('ended', () => {
        if (isPlaying && idx + 1 < timeline.segments.length) {
            showSegment(idx + 1);
            playSegmentAudio(idx + 1);
        }
    });
    audio.addEventListener('error', () => {
        // No audio available, auto-advance after estimated duration
        if (isPlaying && idx + 1 < timeline.segments.length) {
            setTimeout(() => {
                if (isPlaying) { showSegment(idx + 1); playSegmentAudio(idx + 1); }
            }, (seg.duration || 10) * 1000);
        }
    });
    audio.play().catch(() => {});
    currentAudio = audio;
}

function jumpToSegment(idx) {
    if (!timeline) return;
    currentSegIdx = idx;
    showSegment(idx);
    elapsedTime = timeline.segments[idx].start_time;
    updateTimeDisplay();
    if (isPlaying) playSegmentAudio(idx);
}

function seekTo(event) {
    if (!timeline) return;
    const bar = document.getElementById('progress-bar');
    const rect = bar.getBoundingClientRect();
    const pct = (event.clientX - rect.left) / rect.width;
    elapsedTime = pct * totalDuration;
    updateTimeDisplay();
    // Find segment at this time
    for (let i = timeline.segments.length - 1; i >= 0; i--) {
        if (elapsedTime >= timeline.segments[i].start_time) {
            if (i !== currentSegIdx) { showSegment(i); if (isPlaying) playSegmentAudio(i); }
            break;
        }
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
    if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault(); togglePlay();
    }
    if (e.code === 'ArrowRight' && timeline) {
        const next = Math.min(currentSegIdx + 1, timeline.segments.length - 1);
        jumpToSegment(next);
    }
    if (e.code === 'ArrowLeft' && timeline) {
        const prev = Math.max(currentSegIdx - 1, 0);
        jumpToSegment(prev);
    }
});

loadTimeline();
</script>
{% endblock %}
