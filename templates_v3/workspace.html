{% extends "base.html" %}

{% block title %}Workspace - ScreenCast Studio{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}

{% block content %}
<div class="workspace">
    <!-- Header -->
    <header class="workspace-header">
        <div class="header-left">
            <a href="/" class="back-btn">â†</a>
            <span class="logo-icon">ğŸ¬</span>
            <span class="logo-text">ScreenCast Studio</span>
            <span class="divider">|</span>
            <!-- Project Dropdown -->
            <div class="project-dropdown">
                <button class="project-selector" id="project-selector">
                    <span class="project-name" id="project-name">New Project</span>
                    <span class="unsaved-indicator hidden" id="unsaved-indicator">â—</span>
                    <span class="dropdown-arrow">â–¼</span>
                </button>
                <div class="project-menu hidden" id="project-menu">
                    <div class="project-menu-actions">
                        <button class="menu-btn" onclick="newProject()">ğŸ“„ New Project</button>
                        <button class="menu-btn" onclick="saveProject()">ğŸ’¾ Save Project</button>
                        <button class="menu-btn" onclick="saveProjectAs()">ğŸ“ Save As...</button>
                        <button class="menu-btn" onclick="exportProjectDialog()">ğŸ“¦ Export ZIP...</button>
                        <button class="menu-btn" onclick="openProjectFile()">ğŸ“‚ Open ZIP...</button>
                    </div>
                    <div class="project-menu-divider"></div>
                    <div class="project-menu-header">Recent Projects</div>
                    <div class="project-list" id="project-list">
                        <div class="project-list-empty">No saved projects yet</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-center">
            <span class="status-item" id="status-script">â—‹ Script</span>
            <span class="status-item" id="status-tts">â—‹ TTS</span>
            <span class="status-item" id="status-demo">â—‹ Demo</span>
            <span class="status-item" id="status-data">â—‹ Data</span>
        </div>
        <div class="header-right">
            <button id="save-project-btn" class="btn btn-sm" title="Save Project (Ctrl+Shift+S)">ğŸ’¾ Save</button>
            <button class="btn btn-success" onclick="openPresentationMode()">ğŸ¬ Present</button>
            <button id="record-studio-btn" class="btn btn-primary">â–¶ Recording Studio</button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="workspace-main">
        <!-- Left Panel - Input -->
        <div class="panel input-panel">
            <h3 class="panel-title">ğŸ“ PROJECT SETUP</h3>

            <div class="form-group">
                <label>Topic</label>
                <input type="text" id="topic" placeholder="e.g., Identifying Code Bottlenecks" value="Identifying Code Bottlenecks">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Duration</label>
                    <input type="text" id="duration" value="7 min">
                </div>
                <div class="form-group">
                    <label>Audience</label>
                    <select id="audience">
                        <option value="beginner">Beginner</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Bullet Points</label>
                <textarea id="bullets" rows="12">### HOOK
- "Your code runs... but takes 45 seconds"
- Most developers guess wrong about what's slow

### OBJECTIVE
- Identify bottlenecks using profiling tools
- Apply targeted fixes to actual slow code

### CONTENT
- What is a bottleneck? The 90/10 rule
- Tools: cProfile, line_profiler
- Demo: Profile O(nÂ²) code, fix to O(n)

### SUMMARY
- Profile before optimizing
- Small changes â†’ big speedups

### CTA
- Next: Hands-on profiling lab</textarea>
            </div>

            <div class="form-group">
                <label>Demo Requirements</label>
                <textarea id="demo-req" rows="5">Show:
- Slow Python with O(nÂ²) nested loop
- cProfile output showing bottleneck
- Optimized O(n) version
- Timing: 45 sec â†’ 0.3 sec</textarea>
            </div>

            <!-- Environment Selection -->
            <div class="form-group">
                <label>Environment</label>
                <div class="env-grid">
                    <button class="env-btn active" data-env="jupyter">
                        <span class="icon">ğŸ““</span>
                        <span class="name">Jupyter</span>
                    </button>
                    <button class="env-btn" data-env="terminal">
                        <span class="icon">ğŸ’»</span>
                        <span class="name">Terminal</span>
                    </button>
                    <button class="env-btn" data-env="vscode">
                        <span class="icon">ğŸ“</span>
                        <span class="name">VS Code</span>
                    </button>
                    <button class="env-btn" data-env="ipython">
                        <span class="icon">ğŸ</span>
                        <span class="name">IPython</span>
                    </button>
                    <button class="env-btn" data-env="pycharm">
                        <span class="icon">ğŸ”§</span>
                        <span class="name">PyCharm</span>
                    </button>
                </div>
                <button id="recommend-env-btn" class="btn btn-text">ğŸ¤– Get AI Recommendation</button>
            </div>

            <!-- Datasets -->
            <div class="form-group">
                <div class="datasets-header">
                    <label>Datasets</label>
                    <button class="btn btn-text">+ Add</button>
                </div>
                <div id="datasets-list" class="datasets-list">
                    <p class="empty-state">Generate to analyze data needs</p>
                </div>
            </div>
        </div>

        <!-- Center Panel - Preview/Edit -->
        <div class="panel preview-panel">
            <div class="panel-header-row">
                <h3 class="panel-title">ğŸ“ EDIT</h3>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="script">ğŸ“ Script</button>
                <button class="tab" data-tab="tts">ğŸ™ï¸ TTS</button>
                <button class="tab" data-tab="demo">ğŸ’» Demo</button>
                <button class="tab" data-tab="data">ğŸ“Š Data</button>
                <button class="tab" data-tab="report">ğŸ“‹ Report</button>
            </div>

            <!-- Propagation Warning -->
            <div id="propagation-warning" class="propagation-warning hidden">
                <span class="warning-icon">âš ï¸</span>
                <span class="warning-message">Script changed - Related content may need updating</span>
                <div class="warning-actions">
                    <button class="btn btn-sm" onclick="propagateChanges('narration_tts.txt')">Regenerate TTS</button>
                    <button class="btn btn-sm" onclick="checkAlignment()">Check Alignment</button>
                    <button class="btn btn-sm btn-text" onclick="dismissWarning()">Dismiss</button>
                </div>
            </div>

            <div class="tab-content">
                <!-- Script Tab -->
                <div id="tab-script" class="tab-pane active">
                    <div class="editor-toolbar">
                        <div class="section-tabs" id="script-section-tabs">
                            <button class="section-tab active" data-section="all">All</button>
                            <button class="section-tab" data-section="hook">HOOK</button>
                            <button class="section-tab" data-section="objective">OBJECTIVE</button>
                            <button class="section-tab" data-section="content">CONTENT</button>
                            <button class="section-tab" data-section="summary">SUMMARY</button>
                            <button class="section-tab" data-section="cta">CTA</button>
                        </div>
                        <div class="toolbar-actions">
                            <div class="view-toggle" id="script-view-toggle">
                                <button class="view-btn active" data-view="preview" onclick="setScriptView('preview')">ğŸ‘ Preview</button>
                                <button class="view-btn" data-view="edit" onclick="setScriptView('edit')">âœï¸ Edit</button>
                            </div>
                            <span class="sync-status" id="script-sync-status">âœ“ Saved</span>
                            <span class="editor-word-count" id="script-words"></span>
                            <button class="btn btn-sm btn-review" onclick="reviewContent('narration_script.md')" title="Get AI suggestions">ğŸ’¡ Review</button>
                            <button class="btn btn-ai" onclick="openAIAssistant('script')" title="AI Assistant">âœ¨ AI</button>
                            <button class="btn btn-sm" onclick="saveArtifact('narration_script.md')" id="save-script-btn">Save</button>
                        </div>
                    </div>
                    <div id="script-preview" class="content-preview"></div>
                    <textarea id="script-editor" class="editor-textarea" placeholder="Narration script will appear here. Click 'Generate Package' to create content." oninput="handleEditorChange('script-editor')" style="display:none;"></textarea>
                </div>

                <!-- TTS Tab -->
                <div id="tab-tts" class="tab-pane">
                    <div class="editor-toolbar">
                        <div class="toolbar-info">
                            <span class="tts-notice">TTS Optimized: Visual cues removed, acronyms expanded</span>
                        </div>
                        <div class="toolbar-actions">
                            <span class="sync-status" id="tts-sync-status">âœ“ Saved</span>
                            <span class="editor-word-count" id="tts-words"></span>
                            <button class="btn btn-sm btn-regen" onclick="regenerateFromScript()" title="Regenerate TTS from script">ğŸ”„</button>
                            <button class="btn btn-sm btn-review" onclick="reviewContent('narration_tts.txt')" title="Get AI suggestions">ğŸ’¡ Review</button>
                            <button class="btn btn-ai" onclick="openAIAssistant('tts')" title="AI Assistant">âœ¨ AI</button>
                            <button class="btn btn-sm" onclick="saveArtifact('narration_tts.txt')" id="save-tts-btn">Save</button>
                        </div>
                    </div>
                    <textarea id="tts-editor" class="editor-textarea" placeholder="TTS-optimized script will appear here..." oninput="handleEditorChange('tts-editor')"></textarea>
                </div>

                <!-- Demo Tab -->
                <div id="tab-demo" class="tab-pane">
                    <div class="editor-toolbar">
                        <div class="toolbar-info">
                            <span class="demo-badge" id="demo-type-badge">demo.py</span>
                        </div>
                        <div class="toolbar-actions">
                            <span class="sync-status" id="demo-sync-status">âœ“ Saved</span>
                            <span class="editor-word-count" id="demo-lines"></span>
                            <button class="btn btn-sm btn-review" onclick="reviewDemoContent()" title="Get AI suggestions">ğŸ’¡ Review</button>
                            <button class="btn btn-ai" onclick="openAIAssistant('demo')" title="AI Assistant">âœ¨ AI</button>
                            <button class="btn btn-sm" onclick="saveCurrentDemo()" id="save-demo-btn">Save</button>
                        </div>
                    </div>
                    <textarea id="demo-editor" class="editor-textarea code-editor" placeholder="Demo code will appear here..." oninput="handleEditorChange('demo-editor')"></textarea>
                </div>

                <!-- Data Tab -->
                <div id="tab-data" class="tab-pane">
                    <div id="data-preview" class="preview-content"></div>
                </div>

                <!-- Report Tab -->
                <div id="tab-report" class="tab-pane">
                    <div id="report-preview" class="preview-content"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel - AI Chat & Actions -->
        <div class="panel right-panel">
            <h3 class="panel-title">âš¡ ACTIONS</h3>

            <div class="actions-grid">
                <button id="generate-btn" class="btn btn-success btn-large">ğŸ¬ Generate Package</button>
                <button id="align-btn" class="btn">âœ“ Alignment</button>
                <button id="quality-btn" class="btn">ğŸ“Š Quality</button>
                <button id="export-btn" class="btn">ğŸ“¦ Export</button>
                <button id="record-btn" class="btn btn-warning">â–¶ Record</button>
            </div>

            <h3 class="panel-title">ğŸ¤– AI ASSISTANT</h3>

            <div id="chat-container" class="chat-container">
                <div class="chat-message assistant">
                    ğŸ‘‹ Ready to help! Describe what you want to create or modify.
                </div>
            </div>

            <div class="chat-input-row">
                <input type="text" id="chat-input" placeholder="Modify script, data, demo...">
                <button id="send-btn" class="btn btn-primary">Send</button>
            </div>

            <div class="quick-actions">
                <button class="quick-btn" data-action="Make the hook more dramatic">hook</button>
                <button class="quick-btn" data-action="Add data quality issues">data</button>
                <button class="quick-btn" data-action="Switch to terminal demo">terminal</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Generating package...</p>
            <p class="loading-sub">Script â†’ TTS â†’ Demo â†’ Data</p>
        </div>
    </div>

    <!-- Floating AI Assistant Panel -->
    <div id="ai-assistant-panel" class="ai-assistant-panel hidden">
        <div class="ai-panel-header">
            <span class="ai-panel-title">âœ¨ AI Assistant</span>
            <span class="ai-panel-context" id="ai-panel-context">- Script</span>
            <div class="ai-panel-controls">
                <button class="ai-panel-btn" onclick="minimizeAIPanel()" title="Minimize">âˆ’</button>
                <button class="ai-panel-btn" onclick="closeAIPanel()" title="Close">âœ•</button>
            </div>
        </div>
        <div class="ai-panel-body">
            <div class="ai-quick-actions">
                <button class="ai-action-btn" data-action="improve_hook">ğŸ¯ Improve Hook</button>
                <button class="ai-action-btn" data-action="shorten">âœ‚ï¸ Shorten</button>
                <button class="ai-action-btn" data-action="add_cues">ğŸ“º Add Cues</button>
                <button class="ai-action-btn" data-action="add_pauses">â¸ï¸ Add Pauses</button>
                <button class="ai-action-btn" data-action="fix_grammar">âœï¸ Fix Grammar</button>
                <button class="ai-action-btn" data-action="make_conversational">ğŸ’¬ Conversational</button>
            </div>
            <div class="ai-messages" id="ai-messages">
                <div class="ai-message assistant">
                    How can I help improve this content? Click a quick action or describe what you need.
                </div>
            </div>
            <div class="ai-suggestion-box hidden" id="ai-suggestion-box">
                <div class="suggestion-header">
                    <span>ğŸ’¡ Suggestion</span>
                    <button class="btn btn-sm btn-success" onclick="applySuggestion()">Apply</button>
                </div>
                <div class="suggestion-content" id="ai-suggestion-content"></div>
            </div>
            <div class="ai-input-row">
                <input type="text" id="ai-custom-input" placeholder="Ask AI for help...">
                <button class="btn btn-primary" onclick="sendAIRequest()">Send</button>
            </div>
        </div>
    </div>

    <!-- AI Suggestions Panel -->
    <div id="suggestions-panel" class="suggestions-panel" style="display: none;">
        <div class="suggestions-header">
            <div class="suggestions-title-row">
                <h3>ğŸ’¡ AI Suggestions</h3>
                <span class="suggestions-target" id="suggestions-target"></span>
            </div>
            <div class="suggestions-controls">
                <select id="suggestion-focus" onchange="refreshSuggestions()">
                    <option value="general">General Review</option>
                    <option value="clarity">Clarity</option>
                    <option value="engagement">Engagement</option>
                    <option value="structure">WWHAA Structure</option>
                    <option value="technical">Technical Accuracy</option>
                    <option value="tts">TTS Optimization</option>
                </select>
                <button onclick="refreshSuggestions()" class="btn btn-sm">ğŸ”„</button>
                <button onclick="acceptAllSuggestions()" class="btn btn-sm btn-accept-all" title="Accept all suggestions">âœ“ All</button>
                <button onclick="closeSuggestionsPanel()" class="btn btn-sm">âœ•</button>
            </div>
        </div>
        <div class="suggestions-list" id="suggestions-list"></div>
    </div>

    <!-- Unsaved Changes Modal -->
    <div id="unsaved-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Unsaved Changes</span>
            </div>
            <div class="modal-body">
                <p>You have unsaved changes in "<span id="unsaved-project-name">current project</span>".</p>
                <p>Do you want to save before continuing?</p>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="discardAndContinue()">Don't Save</button>
                <button class="btn" onclick="closeUnsavedModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAndContinue()">Save</button>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div id="new-project-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">New Project</span>
                <button class="modal-close" onclick="closeNewProjectModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="new-project-name" placeholder="My Screencast Project">
                </div>
                <div class="form-group">
                    <label>Topic (optional)</label>
                    <input type="text" id="new-project-topic" placeholder="e.g., Python Data Analysis">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeNewProjectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createNewProject()">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Save As Modal -->
    <div id="save-as-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Save Project As</span>
                <button class="modal-close" onclick="closeSaveAsModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="save-as-name" placeholder="My Screencast Project">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeSaveAsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="doSaveAs()">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Delete Project</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="delete-project-name"></span>"?</p>
                <p class="warning-text">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Auto-update toast -->
    <div id="update-toast" class="update-toast" style="display: none;">
        <span>Script saved. Update TTS to match?</span>
        <button onclick="confirmAutoUpdate()">Yes, Update</button>
        <button onclick="dismissToast()">No</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/workspace.js') }}"></script>
{% endblock %}
